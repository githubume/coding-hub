<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å°å·¥ç¨‹å¸ˆè®­ç»ƒåŸºåœ°</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
    }
    header {
      background: #1f2933;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      opacity: 0.8;
      font-size: 12px;
    }
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 50px);
    }
    nav {
      background: #111827;
      color: #e5e7eb;
      padding: 12px;
    }
    nav h2 {
      font-size: 14px;
      margin: 8px 0 4px;
      color: #9ca3af;
    }
    nav button {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 6px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #e5e7eb;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }
    nav button.active {
      background: #374151;
    }
    nav button:hover {
      background: #1f2933;
    }
    nav .small-text {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }
    main {
      padding: 16px 20px 40px;
      overflow-y: auto;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    h2 {
      margin-top: 0;
      font-size: 18px;
      color: #111827;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    }
    .task-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .task-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .task-actions {
      display: flex;
      gap: 8px;
      margin: 6px 0;
      flex-wrap: wrap;
    }
    .btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-link {
      background: #e0f2fe;
    }
    .btn-link:hover {
      background: #bfdbfe;
    }
    .btn-save {
      background: #bbf7d0;
    }
    .btn-save:hover {
      background: #86efac;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      margin: 4px 0;
    }
    textarea {
      width: 100%;
      min-height: 50px;
      font-size: 13px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      resize: vertical;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eef2ff;
      color: #4f46e5;
      margin-right: 4px;
    }
    .small-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .input-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 6px 0;
      font-size: 13px;
    }
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .history-item {
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .history-item strong {
      font-size: 13px;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      background: #e5e7eb;
    }
    .badge.done {
      background: #bbf7d0;
    }
    .muted {
      color: #9ca3af;
      font-size: 12px;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>å°å·¥ç¨‹å¸ˆè®­ç»ƒåŸºåœ°</h1>
    <small id="todayLabel"></small>
  </div>
  <div style="font-size:12px;">
    å½“å‰è®­ç»ƒæ—¥ï¼š<span id="currentDayLabel"></span>
  </div>
</header>

<div class="layout">
  <nav>
    <h2>å¯¼èˆª</h2>
    <button data-section="today" class="active">ğŸ“… ä»Šæ—¥è®­ç»ƒ</button>
    <button data-section="family">ğŸ  å®¶åº­ä»»åŠ¡</button>
    <button data-section="history">ğŸ“œ å†å²è®°å½•</button>
    <button data-section="settings">âš™ï¸ è®¾ç½®ï¼ˆå®¶é•¿ï¼‰</button>
    <div class="small-text">
      æç¤ºï¼šæœ¬é¡µé¢æ•°æ®å­˜å‚¨åœ¨æœ¬æœºæµè§ˆå™¨ localStorage ä¸­ï¼Œä¸ä¼šè”ç½‘ã€‚
    </div>
  </nav>

  <main>
    <!-- ä»Šæ—¥è®­ç»ƒ -->
    <section id="section-today" class="section active">
      <h2>ä»Šæ—¥è®­ç»ƒ</h2>
      <div id="todayTasksContainer"></div>
      <div class="card">
        <div class="task-title">ä»Šæ—¥å°ç»“ï¼ˆå¯é€‰ï¼‰</div>
        <textarea id="todaySummary" placeholder="ä»Šå¤©æˆ‘å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿé‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Ÿ"></textarea>
        <button class="btn btn-save" onclick="saveTodaySummary()">ä¿å­˜ä»Šæ—¥å°ç»“</button>
        <div class="small-label muted" id="todaySummaryStatus"></div>
      </div>
    </section>

    <!-- å®¶åº­ä»»åŠ¡ -->
    <section id="section-family" class="section">
      <h2>ä»Šæ—¥å®¶åº­ä»»åŠ¡</h2>
      <div id="familyTaskContainer"></div>
    </section>

    <!-- å†å²è®°å½• -->
    <section id="section-history" class="section">
      <h2>å†å²è®°å½•</h2>
      <div class="input-inline">
        <label>é€‰æ‹©æ—¥æœŸï¼š</label>
        <input type="date" id="historyDate">
        <button class="btn btn-save" onclick="loadHistory()">æŸ¥çœ‹</button>
      </div>
      <div id="historyContainer" class="card" style="margin-top:10px;"></div>
    </section>

    <!-- è®¾ç½® -->
    <section id="section-settings" class="section">
      <h2>è®¾ç½®ï¼ˆå®¶é•¿ä½¿ç”¨ï¼‰</h2>
      <div class="card">
        <div class="task-title">å½“å‰è®­ç»ƒæ—¥ï¼ˆDayï¼‰</div>
        <div class="input-inline">
          <label for="currentDayInput">Dayï¼š</label>
          <input type="number" id="currentDayInput" min="1" max="365" />
          <button class="btn btn-save" onclick="updateCurrentDay()">ä¿å­˜</button>
        </div>
        <div class="small-label">
          å»ºè®®ï¼šä» Day 1 å¼€å§‹ï¼Œæ¯å¤© +1ã€‚<br>
          åç»­æˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆï¼šDay 1~Day N çš„å®Œæ•´è®­ç»ƒè®¡åˆ’ã€‚
        </div>
      </div>
      <div class="card">
        <div class="task-title">è®­ç»ƒè®¡åˆ’æ•°æ®è¯´æ˜ï¼ˆç»™ä½ çœ‹çš„ï¼‰</div>
        <div class="small-label">
          æœ¬é¡µé¢å†…ç½®äº†ä¸€ä¸ª <code>TASK_DEFINITIONS</code> å˜é‡ï¼Œé‡Œé¢æ˜¯ç±»ä¼¼è¿™æ ·çš„ç»“æ„ï¼š
        </div>
        <pre style="font-size:11px;background:#f9fafb;padding:8px;border-radius:6px;overflow:auto;">
{
  day: 1,
  id: "d1-t1",
  title: "ä»»åŠ¡1ï¼šè®©å°çŒ«å‘å‰èµ°10æ­¥",
  description: "åœ¨ Scratch ä¸­å†™å‡ºï¼šå½“ç»¿æ——è¢«ç‚¹å‡» â†’ ç§»åŠ¨10æ­¥ã€‚",
  type: "code",
  link: "https://studio.code.org/",
  tags: ["äº‹ä»¶", "é¡ºåº"]
}
        </pre>
        <div class="small-label">
          ä½ åé¢å¯ä»¥æ ¹æ®æˆ‘ç»™ä½ çš„è®­ç»ƒè®¡åˆ’ï¼Œå¾€è¿™ä¸ªæ•°ç»„é‡Œè¿½åŠ ä»»åŠ¡ã€‚<br>
          ç¬¬ä¸€æœŸæˆ‘ä»¬å…ˆç”¨å†…ç½®çš„ Day 1~Day 3 ç¤ºä¾‹ã€‚
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // ===== åŸºç¡€å·¥å…·å‡½æ•° =====
  function formatDate(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  // ===== å†…ç½®è®­ç»ƒè®¡åˆ’ï¼ˆç¤ºä¾‹ï¼šDay 1~3ï¼Œå¯åç»­æ‰©å±•ï¼‰ =====
  // åé¢æˆ‘å¯ä»¥æ ¹æ®ä½ å„¿å­çš„æƒ…å†µï¼Œå¸®ä½ ç”Ÿæˆæ›´é•¿çš„ TASK_DEFINITIONSã€‚
  const TASK_DEFINITIONS = [
    // Day 1
    {
      day: 1,
      id: "d1-t1",
      title: "ä»»åŠ¡1ï¼šé¢„æµ‹å°çŒ«ä¼šæ€ä¹ˆåŠ¨",
      description: "åœ¨ Scratch æ–°å»ºé¡¹ç›®ï¼Œæ·»åŠ å°çŒ«ã€‚å†™ï¼šå½“ç»¿æ——è¢«ç‚¹å‡» â†’ ç§»åŠ¨10æ­¥ã€‚å…ˆæƒ³ä¸€æƒ³ï¼Œå†ç‚¹å‡»ç»¿æ——ï¼Œè§‚å¯Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚",
      type: "code",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["äº‹ä»¶", "é¡ºåº"]
    },
    {
      day: 1,
      id: "d1-t2",
      title: "ä»»åŠ¡2ï¼šæ”¹å˜æ­¥æ•°ï¼Œæ¯”è¾ƒæ•ˆæœ",
      description: "æŠŠ10æ­¥æ”¹æˆ50æ­¥ï¼Œé¢„æµ‹ä¸€ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå†è¿è¡ŒéªŒè¯ã€‚",
      type: "code",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["å‚æ•°", "è¯•éªŒ"]
    },
    {
      day: 1,
      id: "d1-t3",
      title: "ä»»åŠ¡3ï¼šè®°å½•ä½ çš„å‘ç°",
      description: "ç”¨ä¸€å¥è¯è¯´æ˜ï¼šæ­¥æ•°è¶Šå¤§ï¼Œå°çŒ«çš„è¿åŠ¨æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ",
      type: "reflection",
      link: "",
      tags: ["æ€»ç»“"]
    },

    // Day 2
    {
      day: 2,
      id: "d2-t1",
      title: "ä»»åŠ¡1ï¼šç†è§£æ–¹å‘ï¼ˆé¢å‘90åº¦ï¼‰",
      description: "åœ¨ Scratch å†™ï¼šå½“ç»¿æ——è¢«ç‚¹å‡» â†’ é¢å‘90åº¦ â†’ ç§»åŠ¨30æ­¥ã€‚å…ˆçŒœä¸€çŒœä¼šå¾€å“ªè¾¹èµ°ã€‚",
      type: "code",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["æ–¹å‘", "é¢„æµ‹"]
    },
    {
      day: 2,
      id: "d2-t2",
      title: "ä»»åŠ¡2ï¼šç”»ä¸€ä¸ªå°åœ†",
      description: "ä½¿ç”¨ï¼šè½ç¬” â†’ é‡å¤20æ¬¡ â†’ ç§»åŠ¨10æ­¥ â†’ å³è½¬18åº¦ï¼Œè¿è¡Œçœ‹çœ‹è½¨è¿¹ã€‚",
      type: "code",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["å¾ªç¯", "å›¾å½¢"]
    },

    // Day 3
    {
      day: 3,
      id: "d3-t1",
      title: "ä»»åŠ¡1ï¼šç»•æ­£æ–¹å½¢èµ°ä¸€åœˆ",
      description: "è®©å°çŒ«ç§»åŠ¨40æ­¥ï¼Œç„¶åå³è½¬90åº¦ï¼Œé‡å¤4æ¬¡ï¼Œå½¢æˆæ­£æ–¹å½¢è½¨è¿¹ã€‚",
      type: "code",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["å¾ªç¯", "å‡ ä½•"]
    },
    {
      day: 3,
      id: "d3-t2",
      title: "ä»»åŠ¡2ï¼šé”™è¯¯è§’åº¦å®éªŒ",
      description: "æŠŠ90åº¦æ”¹æˆ80åº¦ï¼Œå†ç”»ä¸€éã€‚è§‚å¯Ÿå›¾å½¢å˜åŒ–ï¼Œå¹¶æ€è€ƒä¸ºä»€ä¹ˆã€‚",
      type: "experiment",
      link: "https://scratch.mit.edu/projects/editor/",
      tags: ["è°ƒè¯•", "å®éªŒ"]
    }
  ];

  // å®¶åº­ä»»åŠ¡ï¼ˆç¤ºä¾‹ï¼Œå¯æ‰©å±•ï¼‰
  const FAMILY_TASKS = [
    { day: 1, text: "æ•´ç†ä¹¦æ¡Œ5åˆ†é’Ÿï¼Œå¹¶æŠŠä»Šå¤©è¦ç”¨çš„ä¹¦æœ¬æ‘†æ•´é½ã€‚" },
    { day: 2, text: "ç¡å‰è‡ªå·±å‡†å¤‡å¥½æ˜å¤©çš„ä¹¦åŒ…å’Œè¡£æœã€‚" },
    { day: 3, text: "å¸®åŠ©å®¶é‡Œåšä¸€ä»¶å°äº‹ï¼ˆå€’åƒåœ¾/æ”¶æ‹¾ç©å…·ï¼‰ï¼Œå¹¶å‘Šè¯‰çˆ¸å¦ˆä½ åšäº†ä»€ä¹ˆã€‚" }
  ];

  // ===== çŠ¶æ€ç®¡ç† =====
  function getCurrentDay() {
    const stored = localStorage.getItem("currentTrainingDay");
    return stored ? parseInt(stored, 10) : 1;
  }

  function setCurrentDay(day) {
    localStorage.setItem("currentTrainingDay", String(day));
    document.getElementById("currentDayLabel").textContent = "Day " + day;
    document.getElementById("currentDayInput").value = day;
  }

  // è¯»å–æŸå¤©æŸä»»åŠ¡çš„è®°å½•
  function loadTaskState(dateStr, taskId) {
    const key = "training_log_" + dateStr;
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try {
      const data = JSON.parse(raw);
      return data.tasks?.[taskId] || null;
    } catch {
      return null;
    }
  }

  // ä¿å­˜æŸå¤©æŸä»»åŠ¡çš„è®°å½•
  function saveTaskState(dateStr, taskId, state) {
    const key = "training_log_" + dateStr;
    let data = { date: dateStr, tasks: {}, summary: "" };
    const raw = localStorage.getItem(key);
    if (raw) {
      try {
        data = JSON.parse(raw);
      } catch {
        // ignore
      }
    }
    if (!data.tasks) data.tasks = {};
    data.tasks[taskId] = state;
    localStorage.setItem(key, JSON.stringify(data));
  }

  // ä¿å­˜å½“å¤©æ€»ç»“
  function saveTodaySummary() {
    const dateStr = formatDate();
    const key = "training_log_" + dateStr;
    let data = { date: dateStr, tasks: {}, summary: "" };
    const raw = localStorage.getItem(key);
    if (raw) {
      try {
        data = JSON.parse(raw);
      } catch {
        // ignore
      }
    }
    data.summary = document.getElementById("todaySummary").value || "";
    localStorage.setItem(key, JSON.stringify(data));
    const status = document.getElementById("todaySummaryStatus");
    status.textContent = "å·²ä¿å­˜ " + new Date().toLocaleTimeString();
    setTimeout(() => (status.textContent = ""), 2000);
  }

  // ===== ç•Œé¢æ¸²æŸ“ =====
  function renderToday() {
    const todayStr = formatDate();
    document.getElementById("todayLabel").textContent = `ä»Šå¤©ï¼š${todayStr}`;
    const currentDay = getCurrentDay();
    document.getElementById("currentDayLabel").textContent = "Day " + currentDay;

    // æ¸²æŸ“ä»»åŠ¡
    const container = document.getElementById("todayTasksContainer");
    container.innerHTML = "";
    const todaysTasks = TASK_DEFINITIONS.filter(t => t.day === currentDay);
    if (todaysTasks.length === 0) {
      container.innerHTML = '<div class="card"><div class="muted">å½“å‰ Day æ²¡æœ‰é…ç½®ä»»åŠ¡ã€‚ä½ å¯ä»¥åœ¨ä»£ç ä¸­æ‰©å±• TASK_DEFINITIONSã€‚</div></div>';
      return;
    }

    todaysTasks.forEach(task => {
      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "task-title";
      title.textContent = task.title;
      card.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "task-meta";
      meta.textContent = `Day ${task.day} Â· ä»»åŠ¡IDï¼š${task.id}`;
      card.appendChild(meta);

      if (task.tags && task.tags.length) {
        const tagsRow = document.createElement("div");
        task.tags.forEach(tag => {
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = tag;
          tagsRow.appendChild(span);
        });
        card.appendChild(tagsRow);
      }

      const desc = document.createElement("div");
      desc.style.fontSize = "13px";
      desc.style.margin = "6px 0";
      desc.textContent = task.description;
      card.appendChild(desc);

      const actions = document.createElement("div");
      actions.className = "task-actions";

      if (task.link) {
        const linkBtn = document.createElement("button");
        linkBtn.className = "btn btn-link";
        linkBtn.textContent = "æ‰“å¼€ç›¸å…³ç½‘ç«™";
        linkBtn.onclick = () => window.open(task.link, "_blank");
        actions.appendChild(linkBtn);
      }

      const saveBtn = document.createElement("button");
      saveBtn.className = "btn btn-save";
      saveBtn.textContent = "ä¿å­˜æ­¤ä»»åŠ¡è®°å½•";
      actions.appendChild(saveBtn);

      card.appendChild(actions);

      // çŠ¶æ€
      const checkboxRow = document.createElement("div");
      checkboxRow.className = "checkbox-row";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = `chk_${task.id}`;
      const chkLabel = document.createElement("label");
      chkLabel.textContent = "æˆ‘å·²ç»å®Œæˆè¿™ä¸ªä»»åŠ¡";
      checkboxRow.appendChild(checkbox);
      checkboxRow.appendChild(chkLabel);
      card.appendChild(checkboxRow);

      const noteLabel = document.createElement("div");
      noteLabel.className = "small-label";
      noteLabel.textContent = "ç®€å•å†™ä¸€å¥ï¼šæˆ‘åšäº†ä»€ä¹ˆ / æˆ‘å‘ç°äº†ä»€ä¹ˆï¼š";
      card.appendChild(noteLabel);

      const textarea = document.createElement("textarea");
      textarea.id = `note_${task.id}`;
      card.appendChild(textarea);

      const statusRow = document.createElement("div");
      statusRow.className = "small-label muted";
      statusRow.id = `status_${task.id}`;
      card.appendChild(statusRow);

      // åŠ è½½å·²ä¿å­˜çŠ¶æ€
      const saved = loadTaskState(todayStr, task.id);
      if (saved) {
        checkbox.checked = !!saved.done;
        textarea.value = saved.note || "";
      }

      saveBtn.onclick = () => {
        const state = {
          done: checkbox.checked,
          note: textarea.value || "",
          savedAt: new Date().toISOString()
        };
        saveTaskState(todayStr, task.id, state);
        statusRow.textContent = "å·²ä¿å­˜ " + new Date().toLocaleTimeString();
        setTimeout(() => (statusRow.textContent = ""), 2000);
      };

      container.appendChild(card);
    });

    // ä»Šæ—¥æ€»ç»“
    const key = "training_log_" + todayStr;
    const raw = localStorage.getItem(key);
    if (raw) {
      try {
        const data = JSON.parse(raw);
        document.getElementById("todaySummary").value = data.summary || "";
      } catch {
        document.getElementById("todaySummary").value = "";
      }
    } else {
      document.getElementById("todaySummary").value = "";
    }

    // å®¶åº­ä»»åŠ¡
    renderFamilyTask();
  }

  function renderFamilyTask() {
    const currentDay = getCurrentDay();
    const task = FAMILY_TASKS.find(t => t.day === currentDay);
    const container = document.getElementById("familyTaskContainer");
    container.innerHTML = "";
    const card = document.createElement("div");
    card.className = "card";
    if (!task) {
      card.innerHTML = '<div class="muted">å½“å‰ Day æ²¡æœ‰é…ç½®å®¶åº­ä»»åŠ¡ã€‚</div>';
    } else {
      const title = document.createElement("div");
      title.className = "task-title";
      title.textContent = "ä»Šæ—¥å®¶åº­ä»»åŠ¡";

      const text = document.createElement("div");
      text.style.fontSize = "14px";
      text.style.marginTop = "6px";
      text.textContent = task.text;

      const checkboxRow = document.createElement("div");
      checkboxRow.className = "checkbox-row";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = "familyTaskDone";
      const label = document.createElement("label");
      label.textContent = "å·²ç»å®Œæˆ";

      checkboxRow.appendChild(checkbox);
      checkboxRow.appendChild(label);

      const btn = document.createElement("button");
      btn.className = "btn btn-save";
      btn.textContent = "ä¿å­˜å®¶åº­ä»»åŠ¡è®°å½•";

      const status = document.createElement("div");
      status.className = "small-label muted";
      status.id = "familyStatus";

      // åŠ è½½çŠ¶æ€
      const dateStr = formatDate();
      const key = "training_log_" + dateStr;
      const raw = localStorage.getItem(key);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          if (data.familyDone) checkbox.checked = true;
        } catch {}
      }

      btn.onclick = () => {
        const ds = formatDate();
        const k = "training_log_" + ds;
        let data = { date: ds, tasks: {}, summary: "" };
        const r = localStorage.getItem(k);
        if (r) {
          try {
            data = JSON.parse(r);
          } catch {}
        }
        data.familyDone = checkbox.checked;
        localStorage.setItem(k, JSON.stringify(data));
        status.textContent = "å·²ä¿å­˜ " + new Date().toLocaleTimeString();
        setTimeout(() => (status.textContent = ""), 2000);
      };

      card.appendChild(title);
      card.appendChild(text);
      card.appendChild(checkboxRow);
      card.appendChild(btn);
      card.appendChild(status);
    }
    container.appendChild(card);
  }

  function loadHistory() {
    const dateInput = document.getElementById("historyDate");
    const val = dateInput.value;
    if (!val) {
      alert("è¯·å…ˆé€‰æ‹©æ—¥æœŸ");
      return;
    }
    const key = "training_log_" + val;
    const container = document.getElementById("historyContainer");
    container.innerHTML = "";
    const raw = localStorage.getItem(key);
    if (!raw) {
      container.innerHTML = '<div class="muted">è¯¥æ—¥æœŸæ²¡æœ‰è®°å½•ã€‚</div>';
      return;
    }
    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      container.innerHTML = '<div class="muted">è®°å½•æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æã€‚</div>';
      return;
    }

    const summary = document.createElement("div");
    summary.className = "history-item";
    summary.innerHTML = `<strong>æ—¥æœŸï¼š</strong>${val}<br>` +
                        `<strong>ä»Šæ—¥å°ç»“ï¼š</strong>${data.summary || "ï¼ˆæ— ï¼‰"}`;
    container.appendChild(summary);

    const family = document.createElement("div");
    family.className = "history-item";
    family.innerHTML = `<strong>å®¶åº­ä»»åŠ¡ï¼š</strong>` +
                       (data.familyDone ? '<span class="badge done">å·²å®Œæˆ</span>' : '<span class="badge">æœªå®Œæˆ</span>');
    container.appendChild(family);

    if (data.tasks) {
      Object.entries(data.tasks).forEach(([taskId, state]) => {
        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML =
          `<strong>ä»»åŠ¡IDï¼š</strong>${taskId}` +
          (state.done ? '<span class="badge done">å·²å®Œæˆ</span>' : '<span class="badge">æœªå®Œæˆ</span>') +
          `<br><strong>å¤‡æ³¨ï¼š</strong>${state.note || "ï¼ˆæ— ï¼‰"}`;
        container.appendChild(item);
      });
    } else {
      const noTasks = document.createElement("div");
      noTasks.className = "history-item";
      noTasks.innerHTML = "<strong>ä»»åŠ¡è®°å½•ï¼š</strong>æ— ";
      container.appendChild(noTasks);
    }
  }

  function updateCurrentDay() {
    const val = parseInt(document.getElementById("currentDayInput").value, 10);
    if (!val || val < 1) {
      alert("è¯·è¾“å…¥æ­£ç¡®çš„ Day æ•°å­—ï¼ˆ>=1ï¼‰");
      return;
    }
    setCurrentDay(val);
    renderToday();
  }

  // ===== å¯¼èˆªé€»è¾‘ =====
  document.addEventListener("DOMContentLoaded", () => {
    // åˆå§‹åŒ– current day
    const day = getCurrentDay();
    setCurrentDay(day);

    // ä»Šæ—¥æ—¥æœŸé»˜è®¤å¡«å…¥å†å²æŸ¥è¯¢
    document.getElementById("historyDate").value = formatDate();

    // å¯¼èˆªæŒ‰é’®ç»‘å®š
    document.querySelectorAll("nav button[data-section]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("nav button[data-section]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const secId = btn.getAttribute("data-section");
        document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
        document.getElementById("section-" + secId).classList.add("active");
      });
    });

    renderToday();
  });
</script>
</body>
</html>
